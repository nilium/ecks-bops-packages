# Template file for 'go1.12-bootstrap'
pkgname=go1.12-bootstrap
version=1.12.15
revision=1
archs="x86_64* i686* armv[67]l* aarch64* ppc64le*"
wrksrc="go"
short_desc="Go 1.12 (bootstrap compiler)"
maintainer="q66 <daniel@octaforge.org>"
license="BSD-3-Clause"
homepage="https://golang.org"
nostrip=yes
noverifyrdeps=yes
nocross=yes
lib32disabled=yes

if [ "$XBPS_TARGET_LIBC" = "musl" ]; then
	depends+=" gcompat"
	hostmakedepends+=" patchelf"
fi

case "$XBPS_TARGET_MACHINE" in
	x86_64*)
		_dist_arch="amd64"
		checksum="61068419f3d3fcd3cc415c352c4a93d6ae0e723ac18a22ac572b4904d78b5a4c"
		;;
	i686*)
		_dist_arch="386"
		checksum="608c9fb90b2b35f7b4e4b110a9c6919d8902311388c6309487b5f77aed9d2b74"
		;;
	arm*)
		_dist_arch="armv6l"
		checksum="3a36d168bf80c780694bf25d6cb2ed0dbb6d4bc29b1c82bb29e819d9dbe6347b"
		;;
	aarch64*)
		_dist_arch="arm64"
		checksum="cff1a28f0b207dd54230bf822cdcfbcc7cd411261a9366616a05a1fa1fbeedd3"
		;;
	ppc64le*)
		_dist_arch="ppc64le"
		checksum="4fe9ce71a6cd9acd56f0e898dd87d95ed9bc83a6a5be0863e9b5b646e05eee05"
		;;
esac

distfiles="https://dl.google.com/go/go${version}.linux-${_dist_arch}.tar.gz"

post_build() {
	[ "$XBPS_TARGET_LIBC" != "musl" ] && return 0

	# we don't have lib64 compatibility path on musl 64-bit systems
	# use patchelf to replace /lib64/<dynlinker> with /lib/<dynlinker>

	local _interp=$(patchelf --print-interpreter ${wrksrc}/bin/go)

	patchelf --set-interpreter ${_interp/lib64\//lib\/} ${wrksrc}/bin/go
	patchelf --set-interpreter ${_interp/lib64\//lib\/} ${wrksrc}/bin/godoc
}

do_install() {
	vmkdir usr/lib/go1.12
	vcopy bin usr/lib/go1.12
	vcopy src usr/lib/go1.12
	vcopy pkg usr/lib/go1.12
	vlicense LICENSE
}
